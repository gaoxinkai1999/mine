import{r as U,o as F,Y as T,c as $,b as m,w as y,e as z,l as R,m as h,Z as G,k as q,_ as W,g as K,d as L,x as V,t as Y,$ as Z,P as H,I as Q,B as X,a0 as ee}from"./index-C0qELFvz.js";/* empty css              */import"./index-C-sx0Abo.js";import"./index-KpkTHw7S.js";import{F as oe}from"./index-l99pA0pT.js";import{N as ne}from"./index-DvCqQQ0t.js";import{g as ae}from"./_commonjsHelpers-C932wzq6.js";import{_ as te}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{F as ie}from"./index-DkOwyQJK.js";import{P as ue}from"./index-BHDKT0-x.js";import"./use-id-DTylsVlq.js";var x={exports:{}},le=x.exports,B;function se(){return B||(B=1,function(N,C){(function(v,M){N.exports=M()})(le,function(){function v(e){var p=[];return e.AMapUI&&p.push(M(e.AMapUI)),e.Loca&&p.push(w(e.Loca)),Promise.all(p)}function M(e){return new Promise(function(p,i){var u=[];if(e.plugins)for(var l=0;l<e.plugins.length;l+=1)t.AMapUI.plugins.indexOf(e.plugins[l])==-1&&u.push(e.plugins[l]);if(s.AMapUI===n.failed)i("前次请求 AMapUI 失败");else if(s.AMapUI===n.notload){s.AMapUI=n.loading,t.AMapUI.version=e.version||t.AMapUI.version,l=t.AMapUI.version;var f=document.body||document.head,c=document.createElement("script");c.type="text/javascript",c.src="https://webapi.amap.com/ui/"+l+"/main.js",c.onerror=function(r){s.AMapUI=n.failed,i("请求 AMapUI 失败")},c.onload=function(){if(s.AMapUI=n.loaded,u.length)window.AMapUI.loadUI(u,function(){for(var r=0,g=u.length;r<g;r++){var o=u[r].split("/").slice(-1)[0];window.AMapUI[o]=arguments[r]}for(p();d.AMapUI.length;)d.AMapUI.splice(0,1)[0]()});else for(p();d.AMapUI.length;)d.AMapUI.splice(0,1)[0]()},f.appendChild(c)}else s.AMapUI===n.loaded?e.version&&e.version!==t.AMapUI.version?i("不允许多个版本 AMapUI 混用"):u.length?window.AMapUI.loadUI(u,function(){for(var r=0,g=u.length;r<g;r++){var o=u[r].split("/").slice(-1)[0];window.AMapUI[o]=arguments[r]}p()}):p():e.version&&e.version!==t.AMapUI.version?i("不允许多个版本 AMapUI 混用"):d.AMapUI.push(function(r){r?i(r):u.length?window.AMapUI.loadUI(u,function(){for(var g=0,o=u.length;g<o;g++){var a=u[g].split("/").slice(-1)[0];window.AMapUI[a]=arguments[g]}p()}):p()})})}function w(e){return new Promise(function(p,i){if(s.Loca===n.failed)i("前次请求 Loca 失败");else if(s.Loca===n.notload){s.Loca=n.loading,t.Loca.version=e.version||t.Loca.version;var u=t.Loca.version,l=t.AMap.version.startsWith("2"),f=u.startsWith("2");if(l&&!f||!l&&f)i("JSAPI 与 Loca 版本不对应！！");else{l=t.key,f=document.body||document.head;var c=document.createElement("script");c.type="text/javascript",c.src="https://webapi.amap.com/loca?v="+u+"&key="+l,c.onerror=function(r){s.Loca=n.failed,i("请求 AMapUI 失败")},c.onload=function(){for(s.Loca=n.loaded,p();d.Loca.length;)d.Loca.splice(0,1)[0]()},f.appendChild(c)}}else s.Loca===n.loaded?e.version&&e.version!==t.Loca.version?i("不允许多个版本 Loca 混用"):p():e.version&&e.version!==t.Loca.version?i("不允许多个版本 Loca 混用"):d.Loca.push(function(r){r?i(r):i()})})}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var n;(function(e){e.notload="notload",e.loading="loading",e.loaded="loaded",e.failed="failed"})(n||(n={}));var t={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},s={AMap:n.notload,AMapUI:n.notload,Loca:n.notload},d={AMap:[],AMapUI:[],Loca:[]},I=[],k=function(e){typeof e=="function"&&(s.AMap===n.loaded?e(window.AMap):I.push(e))};return{load:function(e){return new Promise(function(p,i){if(s.AMap==n.failed)i("");else if(s.AMap==n.notload){var u=e.key,l=e.version,f=e.plugins;u?(window.AMap&&location.host!=="lbs.amap.com"&&i("禁止多种API加载方式混用"),t.key=u,t.AMap.version=l||t.AMap.version,t.AMap.plugins=f||t.AMap.plugins,s.AMap=n.loading,l=document.body||document.head,window.___onAPILoaded=function(r){if(delete window.___onAPILoaded,r)s.AMap=n.failed,i(r);else for(s.AMap=n.loaded,v(e).then(function(){p(window.AMap)}).catch(i);I.length;)I.splice(0,1)[0]()},f=document.createElement("script"),f.type="text/javascript",f.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+t.AMap.version+"&key="+u+"&plugin="+t.AMap.plugins.join(","),f.onerror=function(r){s.AMap=n.failed,i(r)},l.appendChild(f)):i("请填写key")}else if(s.AMap==n.loaded)if(e.key&&e.key!==t.key)i("多个不一致的 key");else if(e.version&&e.version!==t.AMap.version)i("不允许多个版本 JSAPI 混用");else{if(u=[],e.plugins)for(l=0;l<e.plugins.length;l+=1)t.AMap.plugins.indexOf(e.plugins[l])==-1&&u.push(e.plugins[l]);u.length?window.AMap.plugin(u,function(){v(e).then(function(){p(window.AMap)}).catch(i)}):v(e).then(function(){p(window.AMap)}).catch(i)}else if(e.key&&e.key!==t.key)i("多个不一致的 key");else if(e.version&&e.version!==t.AMap.version)i("不允许多个版本 JSAPI 混用");else{var c=[];if(e.plugins)for(l=0;l<e.plugins.length;l+=1)t.AMap.plugins.indexOf(e.plugins[l])==-1&&c.push(e.plugins[l]);k(function(){c.length?window.AMap.plugin(c,function(){v(e).then(function(){p(window.AMap)}).catch(i)}):v(e).then(function(){p(window.AMap)}).catch(i)})}})},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,t={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},s={AMap:n.notload,AMapUI:n.notload,Loca:n.notload},d={AMap:[],AMapUI:[],Loca:[]}}}})}(x)),x.exports}var re=se();const de=ae(re),pe={class:"map-container"},ce={class:"map-controls"},fe={style:{margin:"16px"}},me={__name:"create",setup(N){const C=z(),v=U(!1),M=U(!1),w=U(!1);let n=null,t=null,s=null;const d=U({name:"",location:"",priceRule:{name:""},longitude:"",latitude:""}),I={text:"name",value:"id"},k=U([]),e=async()=>{window._AMapSecurityConfig={securityJsCode:"49013a8c134717569a059ffcb25c0161"};try{v.value=!0;const o=await R.getCurrentLocation().catch(()=>({longitude:112.348196,latitude:37.603501})),a=await de.load({key:"27f27344e89695fc415a483f46c9c8a9",version:"2.0",plugins:["AMap.Geocoder"]});n=new a.Map("container",{viewMode:"3D",zoom:17,center:[o.longitude,o.latitude]}),t=new a.Marker({position:[o.longitude,o.latitude],map:n,draggable:!0,animation:"AMAP_ANIMATION_DROP"}),s=new a.Geocoder({city:"全国",radius:1e3}),n.on("click",p),t.on("dragend",i),await u([o.longitude,o.latitude])}catch(o){console.error("地图初始化失败:",o),h("地图加载失败，请刷新重试")}finally{v.value=!1}},p=o=>{const a=o.lnglat;t.setPosition(a),u([a.getLng(),a.getLat()])},i=()=>{const o=t.getPosition();u([o.getLng(),o.getLat()])},u=async o=>{try{d.value.longitude=o[0],d.value.latitude=o[1],console.log("当前位置:",JSON.stringify(o));const a=await new Promise((S,_)=>{s.getAddress(o,(P,b)=>{console.log("获取地址信息状态:",JSON.stringify(P)),console.log("获取地址信息结果:",JSON.stringify(b)),P==="complete"&&b.info==="OK"?S(b):_(new Error(`获取地址失败: ${b.info}`))})});d.value.location=a.regeocode.formattedAddress}catch(a){console.error("获取地址信息失败:",a),h("获取地址信息失败")}},l=async()=>{try{Z({message:"定位中...",forbidClick:!0});const o=await R.getCurrentLocation();o&&(n.setCenter([o.longitude,o.latitude]),t.setPosition([o.longitude,o.latitude]),await u([o.longitude,o.latitude]))}catch(o){console.error("重新定位失败:",o),h("定位失败，请检查定位权限")}},f=async()=>{try{M.value=!0,await G({title:"确认提交",message:"是否确认添加该商家？",showCancelButton:!0}),await q.shop.create(d.value),h({type:"success",message:"添加成功"}),C.back()}catch(o){console.error("提交失败:",o),h("提交失败，请重试")}finally{M.value=!1}},c=({selectedOptions:o})=>{w.value=!1,d.value.priceRule=o[0]},r=async()=>{k.value=await q.pricerule.getSimplePriceRules()},g=()=>C.back();return F(()=>{e(),r()}),T(()=>{n&&n.destroy()}),(o,a)=>{const S=ne,_=oe,P=ue,b=H,D=Q,O=X,E=ie,J=ee,j=W;return K(),$("div",null,[m(S,{"left-arrow":"",title:"添加商家",onClickLeft:g}),m(E,{onSubmit:f},{default:y(()=>[m(_,{modelValue:d.value.name,"onUpdate:modelValue":a[0]||(a[0]=A=>d.value.name=A),rules:[{required:!0,message:"请输入商家名称"}],label:"商家名",name:"商家名",placeholder:"请输入商家名称",required:""},null,8,["modelValue"]),m(_,{modelValue:d.value.location,"onUpdate:modelValue":a[1]||(a[1]=A=>d.value.location=A),rules:[{required:!0,message:"请选择位置"}],disabled:"",label:"位置",name:"位置",placeholder:"点击地图选择位置"},null,8,["modelValue"]),m(_,{rules:[{required:!0,message:"请选择价格规则"}],modelValue:d.value.priceRule.name,"onUpdate:modelValue":a[2]||(a[2]=A=>d.value.priceRule.name=A),clickable:"",label:"价格规则",name:"picker",readonly:"",required:"",onClick:a[3]||(a[3]=A=>w.value=!0)},null,8,["modelValue"]),m(b,{show:w.value,"onUpdate:show":a[5]||(a[5]=A=>w.value=A),position:"bottom"},{default:y(()=>[m(P,{columns:k.value,"show-toolbar":"",onCancel:a[4]||(a[4]=A=>w.value=!1),onConfirm:c,"columns-field-names":I},null,8,["columns"])]),_:1},8,["show"]),L("div",pe,[a[7]||(a[7]=L("div",{class:"map-tip"},"点击地图选择具体位置",-1)),a[8]||(a[8]=L("div",{id:"container"},null,-1)),L("div",ce,[m(O,{size:"small",type:"primary",onClick:l},{icon:y(()=>[m(D,{name:"aim"})]),default:y(()=>[a[6]||(a[6]=V(" 定位到当前位置 "))]),_:1})])]),L("div",fe,[m(O,{loading:M.value,block:"","native-type":"submit",round:"",type:"primary"},{default:y(()=>[V(Y(M.value?"提交中...":"提交"),1)]),_:1},8,["loading"])])]),_:1}),m(j,{show:v.value,class:"loading-overlay"},{default:y(()=>[m(J,{type:"spinner",vertical:""},{default:y(()=>a[9]||(a[9]=[V("加载中...")])),_:1})]),_:1},8,["show"])])}}},Le=te(me,[["__scopeId","data-v-77f23a11"]]);export{Le as default};
