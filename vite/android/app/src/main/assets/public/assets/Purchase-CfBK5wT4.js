import{C as nt,E as lt,r as f,a1 as ct,b5 as rt,j as P,J as G,b8 as it,bN as ut,b7 as dt,b as i,ay as ft,M as K,bc as pt,bf as mt,bs as ht,bJ as vt,U as _t,h as gt,k as H,p as $,m as W,n as yt,c as E,d as c,w as _,t as b,y as Ct,e as kt,Z as M,B as bt,P as wt,g as w,F as Q,q as X,v as J,x as R,z as Pt}from"./index-C0qELFvz.js";import{P as St}from"./index-DXiPnwUA.js";import{L as xt}from"./index-Cp1fqY-c.js";import{C as Lt}from"./index-KpkTHw7S.js";import"./index-l99pA0pT.js";import{S as Bt}from"./index-CzMMTJ2E.js";import{C as It}from"./index-CJZx8lX5.js";import{E as Tt}from"./index-JzpjVZKK.js";import{S as Vt}from"./index-Di8JCeMk.js";import{N as Nt}from"./index-DvCqQQ0t.js";import{_ as qt}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-tab-status-Bni8MSz3.js";import"./use-id-DTylsVlq.js";const[At,O]=nt("swipe-cell"),Dt={name:ft(""),disabled:Boolean,leftWidth:K,rightWidth:K,beforeClose:Function,stopPropagation:Boolean};var Et=lt({name:At,props:Dt,emits:["open","close","click"],setup(r,{emit:m,slots:n}){let u,d,h,p;const C=f(),g=f(),y=f(),o=ct({offset:0,dragging:!1}),l=rt(),S=s=>s.value?pt(s).width:0,B=P(()=>G(r.leftWidth)?+r.leftWidth:S(g)),k=P(()=>G(r.rightWidth)?+r.rightWidth:S(y)),T=s=>{o.offset=s==="left"?B.value:-k.value,u||(u=!0,m("open",{name:r.name,position:s}))},x=s=>{o.offset=0,u&&(u=!1,m("close",{name:r.name,position:s}))},U=s=>{const e=Math.abs(o.offset),t=.15,v=u?1-t:t,L=s==="left"?B.value:k.value;L&&e>L*v?T(s):x(s)},V=s=>{r.disabled||(h=o.offset,l.start(s))},z=s=>{if(r.disabled)return;const{deltaX:e}=l;l.move(s),l.isHorizontal()&&(d=!0,o.dragging=!0,(!u||e.value*h<0)&&mt(s,r.stopPropagation),o.offset=ht(e.value+h,-k.value,B.value))},N=()=>{o.dragging&&(o.dragging=!1,U(o.offset>0?"left":"right"),setTimeout(()=>{d=!1},0))},q=(s="outside",e)=>{p||(m("click",s),u&&!d&&(p=!0,vt(r.beforeClose,{args:[{event:e,name:r.name,position:s}],done:()=>{p=!1,x(s)},canceled:()=>p=!1,error:()=>p=!1})))},A=(s,e)=>t=>{e&&t.stopPropagation(),!d&&q(s,t)},D=(s,e)=>{const t=n[s];if(t)return i("div",{ref:e,class:O(s),onClick:A(s,!0)},[t()])};return it({open:T,close:x}),ut(C,s=>q("outside",s),{eventName:"touchstart"}),dt("touchmove",z,{target:C}),()=>{var s;const e={transform:`translate3d(${o.offset}px, 0, 0)`,transitionDuration:o.dragging?"0s":".6s"};return i("div",{ref:C,class:O(),onClick:A("cell",d),onTouchstartPassive:V,onTouchend:N,onTouchcancel:N},[i("div",{class:O("wrapper"),style:e},[D("left",g),(s=n.default)==null?void 0:s.call(n),D("right",y)])])}}});const Rt=_t(Et),Wt=gt("purchase",()=>{const r=f([]),m=f([]),n=f([]),u=P(()=>n.value.reduce((o,l)=>o+l.totalAmount,0));async function d(){await p(),await h()}async function h(){try{r.value=await H.product.getProducts()}catch(o){console.error("获取商品列表失败:",o),$("获取商品列表失败")}}async function p(){try{m.value=await H.category.getCategories()}catch(o){console.error("获取商品列表失败:",o),$("获取商品列表失败")}}function C(o){const l=n.value.findIndex(S=>S.productId===o.productId);o.quantity===0?l>-1&&n.value.splice(l,1):l>-1?n.value[l]={...o}:n.value.push({...o})}function g(){n.value=[]}async function y(){if(n.value.length===0)return W("请先添加采购商品"),!1;try{const o={details:n.value.map(l=>({productId:l.productId,quantity:l.quantity,totalAmount:l.totalAmount,productionDate:l.productionDate,expirationDate:l.expirationDate}))};return await H.purchase.createPurchase(o),yt("提交成功"),g(),!0}catch(o){return console.error("提交采购单失败:",o),$("提交失败，请重试"),!1}}return{products:r,purchaseList:n,categories:m,totalAmount:u,init:d,updatePurchaseList:C,clearPurchaseList:g,submitPurchase:y}}),Ut={class:"page"},zt={class:"content"},Ft={class:"product-item"},Ht={class:"product-info"},$t={class:"product-name"},Mt={class:"product-amount"},Jt={class:"product-controls"},Ot={key:0,class:"total-section"},jt={class:"total-amount"},Gt={class:"footer"},Kt={class:"product-selector"},Qt={class:"selector-header"},Xt={class:"selector-content"},Zt={class:"product-info"},Yt={class:"product-title"},te={class:"product-spec"},ee={class:"product-detail"},oe={class:"product-price"},se={class:"product-stock"},ae={__name:"Purchase",setup(r){const m=kt(),n=Wt(),u=f(!1),d=f(""),h=f(!1),p=f(!1),C=f(!1),g=f(!1),y=P(()=>n.products),o=P(()=>n.purchaseList),l=P(()=>n.totalAmount),S=P(()=>{if(!d.value)return y.value;const e=d.value.toLowerCase();return y.value.filter(t=>t.name.toLowerCase().includes(e)||t.specification.toLowerCase().includes(e))});function B(){o.value.length?M({title:"提示",message:"确定要离开吗？已自动保存为草稿",confirmButtonText:"确定",cancelButtonText:"取消"}).then(e=>{e==="confirm"&&m.back()}):m.back()}function k(e){return Number(e||0).toFixed(2)}function T(e){const t=y.value.find(v=>v.id===e);return t?t.stock:0}function x(e,t){const v=y.value.find(L=>L.id===e.productId);v&&n.updatePurchaseList({...e,quantity:t,totalAmount:t*v.price})}function U(e){M({title:"提示",message:"确定要删除该商品吗？",showCancelButton:!0}).then(t=>{t==="confirm"&&(n.updatePurchaseList({...e,quantity:0}),W("已删除"))})}function V(){h.value=!1,p.value=!1,C.value=!1}function z(){d.value="",V()}function N(){n.init().then(()=>{g.value=!1,W("刷新成功")})}function q(){h.value=!1,p.value=!0}function A(e){return o.value.some(t=>t.productId===e)}function D(e){const t=o.value.find(v=>v.productId===e.id);t?x(t,t.quantity+1):n.updatePurchaseList({productId:e.id,productName:e.name,quantity:1,totalAmount:e.price}),W({type:"success",message:"已添加",position:"bottom"})}function s(){M({title:"提示",message:"确定要提交采购单吗？",showCancelButton:!0}).then(e=>{e==="confirm"&&n.submitPurchase().then(t=>{t&&m.back()})})}return n.init(),(e,t)=>{const v=Nt,L=Vt,F=bt,j=Lt,Z=Rt,Y=Tt,tt=It,et=Bt,ot=xt,st=St,at=wt;return w(),E("div",Ut,[i(v,{title:"新建采购单","left-arrow":"",onClickLeft:B}),c("div",zt,[i(tt,{title:"商品清单",class:"purchase-list"},{default:_(()=>[o.value.length?(w(!0),E(Q,{key:0},X(o.value,a=>(w(),J(Z,{key:a.productId,class:"purchase-item"},{default:_(()=>[i(j,null,{title:_(()=>[c("div",Ft,[c("div",Ht,[c("span",$t,b(a.productName),1),c("span",Mt,"¥"+b(k(a.totalAmount)),1)]),c("div",Jt,[i(L,{modelValue:a.quantity,"onUpdate:modelValue":I=>a.quantity=I,min:1,max:T(a.productId),onChange:I=>x(a,I)},null,8,["modelValue","onUpdate:modelValue","max","onChange"]),i(F,{type:"danger",size:"small",class:"delete-btn",onClick:I=>U(a)},{default:_(()=>t[5]||(t[5]=[R("删除")])),_:2},1032,["onClick"])])])]),_:2},1024)]),_:2},1024))),128)):(w(),J(Y,{key:1,description:"暂无采购商品"}))]),_:1}),i(F,{type:"primary",size:"large",icon:"plus",class:"add-button",onClick:t[0]||(t[0]=a=>u.value=!0)},{default:_(()=>t[6]||(t[6]=[R(" 添加商品 ")])),_:1}),o.value.length?(w(),E("div",Ot,[t[7]||(t[7]=c("span",{class:"total-label"},"合计金额",-1)),c("span",jt,"¥"+b(k(l.value)),1)])):Ct("",!0)]),c("div",Gt,[i(F,{type:"primary",block:"",disabled:!o.value.length,onClick:s},{default:_(()=>t[8]||(t[8]=[R(" 提交采购单 ")])),_:1},8,["disabled"])]),i(at,{show:u.value,"onUpdate:show":t[4]||(t[4]=a=>u.value=a),position:"bottom",style:{height:"70%"},class:"product-selector-popup",closeable:"",round:""},{default:_(()=>[c("div",Kt,[c("div",Qt,[t[9]||(t[9]=c("span",{class:"selector-title"},"选择商品",-1)),i(et,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=a=>d.value=a),placeholder:"搜索商品名称",shape:"round",onSearch:V,onClear:z},null,8,["modelValue"])]),c("div",Xt,[i(st,{modelValue:g.value,"onUpdate:modelValue":t[3]||(t[3]=a=>g.value=a),onRefresh:N},{default:_(()=>[i(ot,{loading:h.value,"onUpdate:loading":t[2]||(t[2]=a=>h.value=a),finished:p.value,error:C.value,"error-text":"请求失败，点击重试","finished-text":"没有更多了",onLoad:q},{default:_(()=>[(w(!0),E(Q,null,X(S.value,a=>(w(),J(j,{key:a.id,class:Pt(["product-cell",{selected:A(a.id)}]),onClick:I=>D(a)},{title:_(()=>[c("div",Zt,[c("div",Yt,[R(b(a.name)+" ",1),c("span",te,b(a.specification),1)]),c("div",ee,[c("span",oe,"¥"+b(k(a.price)),1),c("span",se,"库存："+b(a.stock),1)])])]),_:2},1032,["class","onClick"]))),128))]),_:1},8,["loading","finished","error"])]),_:1},8,["modelValue"])])])]),_:1},8,["show"])])}}},ge=qt(ae,[["__scopeId","data-v-bec38145"]]);export{ge as default};
