import{h as L,e as T,r as a,j as f,l as q,k as u,p as g,m as F,n as j}from"./index-C0qELFvz.js";const E=L("returnOrder",()=>{const S=T(),p=a({}),i=a(0),l=a([]),o=a([]),r=a([]),s=a([{id:128,name:"育青苑小卖部",latitude:37.602938,longitude:112.348135,address:"育青苑小区",distance:43.45429229736328},{id:243,name:"晋乐山驴肉店",latitude:37.60148,longitude:112.350471,address:"商业南街",distance:270.90704345703125}]),w=a(!1),n=a({}),m=f(()=>o.value.filter(e=>{var t;return e.categoryId==((t=l.value[i.value])==null?void 0:t.id)})),b=f(()=>r.value.reduce((e,t)=>e+Number(t.amount),0)),C=f(()=>r.value.reduce((e,t)=>e+1,0));async function I(){await O(),await Promise.all([v(),h()])}async function O(){try{const e=await q.getNearbyShops();p.value=e.currentLocation,s.value=e.nearbyShops}catch(e){console.error("获取位置信息失败:",e)}finally{const e=await u.shop.getShop({id:s.value[0].id});n.value={...e,distance:s.value[0].distance}}}async function v(){try{l.value=await u.category.getCategories()}catch(e){console.error("获取分类失败:",e)}}async function h(){try{const e=await u.product.getProductSaleList({shopId:n.value.id});o.value=e.map(t=>({...t,count:0}))}catch(e){console.error("获取商品失败:",e)}}async function N(e){try{const t=await u.shop.getShop({id:e.id});return n.value={...t,distance:e.distance},d(),await Promise.all([v(),h()]),i.value=0,!0}catch(t){return console.error("切换商家失败:",t),g("切换商家失败，请重试"),!1}}function P(e){const t=r.value.find(c=>c.id===e.id);e.count===0?r.value=r.value.filter(c=>c.id!==e.id):t?t.count=e.count:r.value.push({id:e.id,name:e.name,price:e.price,count:e.count});const y=o.value.find(c=>c.id===e.id);y&&(y.count=e.count)}function d(){r.value=[],o.value.forEach(e=>e.count=0)}function R(e){const t=r.value.indexOf(e);t!==-1&&r.value.splice(t,1)}async function x(){if(r.value.length===0)return F("请先选择退货商品"),!1;try{const e={shopId:n.value.id,details:r.value.map(t=>({productId:t.id,amount:Number(t.amount),type:t.type,quantity:t.type==="退货退款"?Number(t.quantity):null}))};return await u.returnorder.createReturnOrder(e),j("退货单提交成功"),d(),S.push("/order/list"),!0}catch(e){return console.error("退货单提交失败:",e),g("退货单提交失败，请重试"),!1}}return{activeCategory:i,categories:l,foods:o,cart:r,nearbyShops:s,showCart:w,currentLocation:p,currentShop:n,currentFoods:m,totalPrice:b,totalCount:C,init:I,updateCart:P,clearCart:d,submitReturnOrder:x,removeCartItem:R,changeShop:N}});export{E as u};
